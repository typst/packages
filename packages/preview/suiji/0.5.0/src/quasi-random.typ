//==============================================================================
// Quasi-Random number generator
//
// Public functions:
//     haltonset
//==============================================================================


//----------------------------------------------------------
// Private parameters
//----------------------------------------------------------

// First 30 primes
#let _PRIMES = (2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97, 101, 103, 107, 109, 113)

// Permutations of coefficients
#let _PERMS = (
  (0, 1),
  (0, 2, 1),
  (0, 4, 2, 1, 3),
  (0, 4, 2, 6, 1, 5, 3),
  (0, 8, 4, 2, 10, 6, 1, 9, 5, 3, 7),
  (0, 8, 4, 12, 2, 10, 6, 1, 9, 5, 3, 11, 7),
  (0, 16, 8, 4, 12, 2, 10, 6, 14, 1, 9, 5, 13, 3, 11, 7, 15),
  (0, 16, 8, 4, 12, 2, 18, 10, 6, 14, 1, 17, 9, 5, 13, 3, 11, 7, 15),
  (0, 16, 8, 4, 20, 12, 2, 18, 10, 6, 22, 14, 1, 17, 9, 5, 21, 13, 3, 19, 11, 7, 15),
  (0, 16, 8, 24, 4, 20, 12, 28, 2, 18, 10, 26, 6, 22, 14, 1, 17, 9, 25, 5, 21, 13, 3, 19, 11, 27, 7, 23, 15),
  (0, 16, 8, 24, 4, 20, 12, 28, 2, 18, 10, 26, 6, 22, 14, 30, 1, 17, 9, 25, 5, 21, 13, 29, 3, 19, 11, 27, 7, 23, 15),
  (0, 32, 16, 8, 24, 4, 36, 20, 12, 28, 2, 34, 18, 10, 26, 6, 22, 14, 30, 1, 33, 17, 9, 25, 5, 21, 13, 29, 3, 35, 19, 11, 27, 7, 23, 15, 31),
  (0, 32, 16, 8, 40, 24, 4, 36, 20, 12, 28, 2, 34, 18, 10, 26, 6, 38, 22, 14, 30, 1, 33, 17, 9, 25, 5, 37, 21, 13, 29, 3, 35, 19, 11, 27, 7, 39, 23, 15, 31),
  (0, 32, 16, 8, 40, 24, 4, 36, 20, 12, 28, 2, 34, 18, 10, 42, 26, 6, 38, 22, 14, 30, 1, 33, 17, 9, 41, 25, 5, 37, 21, 13, 29, 3, 35, 19, 11, 27, 7, 39, 23, 15, 31),
  (0, 32, 16, 8, 40, 24, 4, 36, 20, 12, 44, 28, 2, 34, 18, 10, 42, 26, 6, 38, 22, 14, 46, 30, 1, 33, 17, 9, 41, 25, 5, 37, 21, 13, 45, 29, 3, 35, 19, 11, 43, 27, 7, 39, 23, 15, 31),
  (0, 32, 16, 48, 8, 40, 24, 4, 36, 20, 52, 12, 44, 28, 2, 34, 18, 50, 10, 42, 26, 6, 38, 22, 14, 46, 30, 1, 33, 17, 49, 9, 41, 25, 5, 37, 21, 13, 45, 29, 3, 35, 19, 51, 11, 43, 27, 7, 39, 23, 15, 47, 31),
  (0, 32, 16, 48, 8, 40, 24, 56, 4, 36, 20, 52, 12, 44, 28, 2, 34, 18, 50, 10, 42, 26, 58, 6, 38, 22, 54, 14, 46, 30, 1, 33, 17, 49, 9, 41, 25, 57, 5, 37, 21, 53, 13, 45, 29, 3, 35, 19, 51, 11, 43, 27, 7, 39, 23, 55, 15, 47, 31),
  (0, 32, 16, 48, 8, 40, 24, 56, 4, 36, 20, 52, 12, 44, 28, 60, 2, 34, 18, 50, 10, 42, 26, 58, 6, 38, 22, 54, 14, 46, 30, 1, 33, 17, 49, 9, 41, 25, 57, 5, 37, 21, 53, 13, 45, 29, 3, 35, 19, 51, 11, 43, 27, 59, 7, 39, 23, 55, 15, 47, 31),
  (0, 64, 32, 16, 48, 8, 40, 24, 56, 4, 36, 20, 52, 12, 44, 28, 60, 2, 66, 34, 18, 50, 10, 42, 26, 58, 6, 38, 22, 54, 14, 46, 30, 62, 1, 65, 33, 17, 49, 9, 41, 25, 57, 5, 37, 21, 53, 13, 45, 29, 61, 3, 35, 19, 51, 11, 43, 27, 59, 7, 39, 23, 55, 15, 47, 31, 63),
  (0, 64, 32, 16, 48, 8, 40, 24, 56, 4, 68, 36, 20, 52, 12, 44, 28, 60, 2, 66, 34, 18, 50, 10, 42, 26, 58, 6, 70, 38, 22, 54, 14, 46, 30, 62, 1, 65, 33, 17, 49, 9, 41, 25, 57, 5, 69, 37, 21, 53, 13, 45, 29, 61, 3, 67, 35, 19, 51, 11, 43, 27, 59, 7, 39, 23, 55, 15, 47, 31, 63),
  (0, 64, 32, 16, 48, 8, 72, 40, 24, 56, 4, 68, 36, 20, 52, 12, 44, 28, 60, 2, 66, 34, 18, 50, 10, 42, 26, 58, 6, 70, 38, 22, 54, 14, 46, 30, 62, 1, 65, 33, 17, 49, 9, 41, 25, 57, 5, 69, 37, 21, 53, 13, 45, 29, 61, 3, 67, 35, 19, 51, 11, 43, 27, 59, 7, 71, 39, 23, 55, 15, 47, 31, 63),
  (0, 64, 32, 16, 48, 8, 72, 40, 24, 56, 4, 68, 36, 20, 52, 12, 76, 44, 28, 60, 2, 66, 34, 18, 50, 10, 74, 42, 26, 58, 6, 70, 38, 22, 54, 14, 78, 46, 30, 62, 1, 65, 33, 17, 49, 9, 73, 41, 25, 57, 5, 69, 37, 21, 53, 13, 77, 45, 29, 61, 3, 67, 35, 19, 51, 11, 75, 43, 27, 59, 7, 71, 39, 23, 55, 15, 47, 31, 63),
  (0, 64, 32, 16, 80, 48, 8, 72, 40, 24, 56, 4, 68, 36, 20, 52, 12, 76, 44, 28, 60, 2, 66, 34, 18, 82, 50, 10, 74, 42, 26, 58, 6, 70, 38, 22, 54, 14, 78, 46, 30, 62, 1, 65, 33, 17, 81, 49, 9, 73, 41, 25, 57, 5, 69, 37, 21, 53, 13, 77, 45, 29, 61, 3, 67, 35, 19, 51, 11, 75, 43, 27, 59, 7, 71, 39, 23, 55, 15, 79, 47, 31, 63),
  (0, 64, 32, 16, 80, 48, 8, 72, 40, 24, 88, 56, 4, 68, 36, 20, 84, 52, 12, 76, 44, 28, 60, 2, 66, 34, 18, 82, 50, 10, 74, 42, 26, 58, 6, 70, 38, 22, 86, 54, 14, 78, 46, 30, 62, 1, 65, 33, 17, 81, 49, 9, 73, 41, 25, 57, 5, 69, 37, 21, 85, 53, 13, 77, 45, 29, 61, 3, 67, 35, 19, 83, 51, 11, 75, 43, 27, 59, 7, 71, 39, 23, 87, 55, 15, 79, 47, 31, 63),
  (0, 64, 32, 96, 16, 80, 48, 8, 72, 40, 24, 88, 56, 4, 68, 36, 20, 84, 52, 12, 76, 44, 28, 92, 60, 2, 66, 34, 18, 82, 50, 10, 74, 42, 26, 90, 58, 6, 70, 38, 22, 86, 54, 14, 78, 46, 30, 94, 62, 1, 65, 33, 17, 81, 49, 9, 73, 41, 25, 89, 57, 5, 69, 37, 21, 85, 53, 13, 77, 45, 29, 93, 61, 3, 67, 35, 19, 83, 51, 11, 75, 43, 27, 91, 59, 7, 71, 39, 23, 87, 55, 15, 79, 47, 31, 95, 63),
  (0, 64, 32, 96, 16, 80, 48, 8, 72, 40, 24, 88, 56, 4, 68, 36, 100, 20, 84, 52, 12, 76, 44, 28, 92, 60, 2, 66, 34, 98, 18, 82, 50, 10, 74, 42, 26, 90, 58, 6, 70, 38, 22, 86, 54, 14, 78, 46, 30, 94, 62, 1, 65, 33, 97, 17, 81, 49, 9, 73, 41, 25, 89, 57, 5, 69, 37, 21, 85, 53, 13, 77, 45, 29, 93, 61, 3, 67, 35, 99, 19, 83, 51, 11, 75, 43, 27, 91, 59, 7, 71, 39, 23, 87, 55, 15, 79, 47, 31, 95, 63),
  (0, 64, 32, 96, 16, 80, 48, 8, 72, 40, 24, 88, 56, 4, 68, 36, 100, 20, 84, 52, 12, 76, 44, 28, 92, 60, 2, 66, 34, 98, 18, 82, 50, 10, 74, 42, 26, 90, 58, 6, 70, 38, 102, 22, 86, 54, 14, 78, 46, 30, 94, 62, 1, 65, 33, 97, 17, 81, 49, 9, 73, 41, 25, 89, 57, 5, 69, 37, 101, 21, 85, 53, 13, 77, 45, 29, 93, 61, 3, 67, 35, 99, 19, 83, 51, 11, 75, 43, 27, 91, 59, 7, 71, 39, 23, 87, 55, 15, 79, 47, 31, 95, 63),
  (0, 64, 32, 96, 16, 80, 48, 8, 72, 40, 104, 24, 88, 56, 4, 68, 36, 100, 20, 84, 52, 12, 76, 44, 28, 92, 60, 2, 66, 34, 98, 18, 82, 50, 10, 74, 42, 106, 26, 90, 58, 6, 70, 38, 102, 22, 86, 54, 14, 78, 46, 30, 94, 62, 1, 65, 33, 97, 17, 81, 49, 9, 73, 41, 105, 25, 89, 57, 5, 69, 37, 101, 21, 85, 53, 13, 77, 45, 29, 93, 61, 3, 67, 35, 99, 19, 83, 51, 11, 75, 43, 27, 91, 59, 7, 71, 39, 103, 23, 87, 55, 15, 79, 47, 31, 95, 63),
  (0, 64, 32, 96, 16, 80, 48, 8, 72, 40, 104, 24, 88, 56, 4, 68, 36, 100, 20, 84, 52, 12, 76, 44, 108, 28, 92, 60, 2, 66, 34, 98, 18, 82, 50, 10, 74, 42, 106, 26, 90, 58, 6, 70, 38, 102, 22, 86, 54, 14, 78, 46, 30, 94, 62, 1, 65, 33, 97, 17, 81, 49, 9, 73, 41, 105, 25, 89, 57, 5, 69, 37, 101, 21, 85, 53, 13, 77, 45, 29, 93, 61, 3, 67, 35, 99, 19, 83, 51, 11, 75, 43, 107, 27, 91, 59, 7, 71, 39, 103, 23, 87, 55, 15, 79, 47, 31, 95, 63),
  (0, 64, 32, 96, 16, 80, 48, 112, 8, 72, 40, 104, 24, 88, 56, 4, 68, 36, 100, 20, 84, 52, 12, 76, 44, 108, 28, 92, 60, 2, 66, 34, 98, 18, 82, 50, 10, 74, 42, 106, 26, 90, 58, 6, 70, 38, 102, 22, 86, 54, 14, 78, 46, 110, 30, 94, 62, 1, 65, 33, 97, 17, 81, 49, 9, 73, 41, 105, 25, 89, 57, 5, 69, 37, 101, 21, 85, 53, 13, 77, 45, 109, 29, 93, 61, 3, 67, 35, 99, 19, 83, 51, 11, 75, 43, 107, 27, 91, 59, 7, 71, 39, 103, 23, 87, 55, 15, 79, 47, 111, 31, 95, 63),
)


//----------------------------------------------------------
// Public functions
//----------------------------------------------------------

// Return a Halton sequence point set
//
// Arguments:
//     dim: number of dimensions in the set, effective value is an integer from [1, 30]
//     size: returned points array size, must be none or non-negative integer, optional
//     skip: number of initial points to omit, optional
//     leap: number of points to miss out between returned points, optional
//     permutation: whether use permutations of coefficients in each of the radical inverse functions, optional
//
// Returns:
//     arr: array of points
#let haltonset(dim, size: none, skip: 0, leap: 0, permutation: true) = {
  assert(type(dim) == int and dim >= 1 and dim <= 30, message: "`dim` should be in range [1, 30]")
  assert((size == none) or (type(size) == int and size >= 0), message: "`size` should be non-negative")
  assert(type(skip) == int and skip >= 0, message: "`skip` should be non-negative")
  assert(type(leap) == int and leap >= 0, message: "`leap` should be non-negative")
  assert(type(permutation) == bool, message: "`permutation` should be bool")

  leap += 1
  let n = if size == none {1} else {size}
  let arr = (0.0,) * dim * n
  let b = 0
  let p = ()
  let a = 0
  let pt-idx = 0
  let idx = 0
  let idx-new = 0
  let x = 0.0
  let rdx = 0
  for k in range(dim) {
    b = _PRIMES.at(k)
    if permutation {
      p = _PERMS.at(k)
    }
    pt-idx = skip
    for c in range(n) {
      idx = pt-idx
      x = 0.0
      rdx = b
      while idx > 0 {
        idx-new = calc.div-euclid(idx, b)
        a = idx - b * idx-new
        idx = idx-new
        if permutation {
          a = p.at(a)    // permute coefficients
        }
        x += a / rdx
        rdx *= b
      }
      arr.at(c * dim + k) = x
      pt-idx += leap
    }
  }

  if dim == 1 or n == 1 {
    return arr
  } else {
    return arr.chunks(dim)
  }
}
