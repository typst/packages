// Features module - Distinctive feature matrices from Hayes (2009)
// Based on Hayes, B. (2009). Introductory Phonology. Wiley-Blackwell.

#import "ipa.typ": ipa-to-unicode
#import "_config.typ": phonokit-font

// Function for feature matrices in SPE notation
/// Display feature matrix in SPE-style notation
///
/// Creates a bracketed vertical list of features using math.vec.
/// Handles both individual arguments and comma-separated strings.
///
/// Arguments:
/// - args (variadic): Feature specifications (e.g., "+consonantal", "-sonorant")
///   Can be passed as separate arguments or as a single comma-separated string
///
/// Returns: Formatted feature matrix with proper spacing to prevent overlaps
///
/// Example:
/// ```
/// #feat("+consonantal", "-sonorant", "+voice")
/// #feat("+cons,-son,+voice")  // comma-separated also works
/// ```
#let feat(..args) = context {
  let items = args.pos()

  // 1. Split string if comma-separated
  if items.len() == 1 and type(items.at(0)) == str and items.at(0).contains(",") {
    items = items.at(0).split(",")
  }

  // 2. Style the items
  let features = items.map(i => {
    let content = if type(i) == str { i.trim() } else { i }
    text(font: phonokit-font.get(), size: 1em, content)
  })

  // 3. Use math.vec for perfect axis alignment
  set math.vec(gap: 0.5em)
  let matrix = math.vec(delim: "[", ..features)

  // 4. Use box with vertical padding to add space around matrices
  // This prevents overlaps while keeping matrices inline-friendly
  box(
    baseline: 50%,
    inset: (top: 0.5em, bottom: 0.5em),
    matrix,
  )
}

// Complete feature specifications for consonants and vowels
// Features: +, -, or 0 (not applicable/unspecified)
#let feature-data = (
  // CONSONANTS - Single place of articulation (Table 4.7)
  // Bilabial
  "p": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "+",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "b": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "+",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ɸ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "+",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "β": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "+",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "m": (
    consonantal: "+",
    sonorant: "+",
    continuant: "–",
    delayed_release: "0",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "+",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "+",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "–",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ʙ": (
    consonantal: "+",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "–",
    trill: "+",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "+",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  // Labiodental
  "f": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "+",
    round: "–",
    labiodental: "+",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "–",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "v": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "+",
    round: "–",
    labiodental: "+",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "–",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ɱ": (
    consonantal: "+",
    sonorant: "+",
    continuant: "–",
    delayed_release: "0",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "+",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "+",
    round: "–",
    labiodental: "+",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ʋ": (
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "+",
    round: "–",
    labiodental: "+",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  // Dental
  "θ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "+",
    strident: "–",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ð": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "+",
    strident: "–",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  // Alveolar
  "t": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "–",
    strident: "–",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "d": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "–",
    strident: "–",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "t͡s": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "–",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "d͡z": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "–",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "s": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "–",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "z": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "–",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "n": (
    consonantal: "+",
    sonorant: "+",
    continuant: "–",
    delayed_release: "0",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "+",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "–",
    strident: "–",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "l": (
    consonantal: "+",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "–",
    strident: "–",
    lateral: "+",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ɾ": (
    consonantal: "+",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "+",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "–",
    strident: "–",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "r": (
    consonantal: "+",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "–",
    trill: "+",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "–",
    strident: "–",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  // Postalveolar
  "ʃ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "+",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ʒ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "+",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "t͡ʃ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "+",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "d͡ʒ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "+",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  // Retroflex
  "ʈ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "–",
    distributed: "+",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ɖ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "–",
    distributed: "+",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ʂ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "–",
    distributed: "+",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ʐ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "–",
    distributed: "+",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ɳ": (
    consonantal: "+",
    sonorant: "+",
    continuant: "–",
    delayed_release: "0",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "+",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "–",
    distributed: "+",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ɭ": (
    consonantal: "+",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "–",
    distributed: "+",
    strident: "+",
    lateral: "+",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ɽ": (
    consonantal: "+",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "+",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "–",
    distributed: "+",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ɻ": (
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "–",
    distributed: "+",
    strident: "+",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  // Palatal
  "c": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "+",
    back: "–",
    tense: "0",
  ),
  "ɟ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "+",
    back: "–",
    tense: "0",
  ),
  "ç": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "+",
    back: "–",
    tense: "0",
  ),
  "ʝ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "+",
    back: "–",
    tense: "0",
  ),
  "ɲ": (
    consonantal: "+",
    sonorant: "+",
    continuant: "–",
    delayed_release: "0",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "+",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "+",
    back: "–",
    tense: "0",
  ),
  "ʎ": (
    consonantal: "+",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "+",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "+",
    back: "–",
    tense: "0",
  ),
  "j": (
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "+",
    back: "–",
    tense: "+",
  ),
  // Velar
  "k": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "–",
    back: "0",
    tense: "0",
  ),
  "g": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "–",
    back: "0",
    tense: "0",
  ),
  "x": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "–",
    back: "0",
    tense: "0",
  ),
  "ɣ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "–",
    back: "0",
    tense: "0",
  ),
  "ŋ": (
    consonantal: "+",
    sonorant: "+",
    continuant: "–",
    delayed_release: "0",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "+",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "–",
    back: "0",
    tense: "0",
  ),
  "ɰ": (
    consonantal: "+",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "–",
    back: "0",
    tense: "0",
  ),
  // Uvular
  "q": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "–",
    low: "–",
    front: "–",
    back: "+",
    tense: "0",
  ),
  "ɢ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "–",
    low: "–",
    front: "–",
    back: "+",
    tense: "0",
  ),
  "χ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "–",
    low: "–",
    front: "–",
    back: "+",
    tense: "0",
  ),
  "ʁ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "–",
    low: "–",
    front: "–",
    back: "+",
    tense: "0",
  ),
  "ɴ": (
    consonantal: "+",
    sonorant: "+",
    continuant: "–",
    delayed_release: "0",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "+",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "–",
    low: "–",
    front: "–",
    back: "+",
    tense: "0",
  ),
  "ʀ": (
    consonantal: "+",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "–",
    trill: "+",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "–",
    low: "–",
    front: "–",
    back: "+",
    tense: "0",
  ),
  // Pharyngeal
  "ħ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "+",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "–",
    low: "+",
    front: "–",
    back: "+",
    tense: "0",
  ),
  "ʕ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "+",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "–",
    low: "+",
    front: "–",
    back: "+",
    tense: "0",
  ),
  // Glottal
  "ʔ": (
    consonantal: "+",
    sonorant: "–",
    continuant: "–",
    delayed_release: "–",
    approximant: "–",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "+",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "h": (
    consonantal: "–",
    sonorant: "–",
    continuant: "–",
    delayed_release: "+",
    approximant: "+",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "–",
    spread_gl: "+",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  "ɦ": (
    consonantal: "–",
    sonorant: "–",
    continuant: "–",
    delayed_release: "+",
    approximant: "+",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "+",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "–",
    high: "0",
    low: "0",
    front: "0",
    back: "0",
    tense: "0",
  ),
  // Complex segments (Table 4.8)
  "w": (
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "+",
    round: "+",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "–",
    back: "+",
    tense: "+",
  ),
  "ɥ": (
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "+",
    round: "+",
    labiodental: "–",
    coronal: "–",
    anterior: "0",
    distributed: "0",
    strident: "0",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "+",
    back: "–",
    tense: "+",
  ),
  "ɹ": (
    consonantal: "+",
    sonorant: "+",
    continuant: "+",
    delayed_release: "0",
    approximant: "+",
    tap: "–",
    trill: "–",
    nasal: "–",
    voice: "+",
    spread_gl: "–",
    constr_gl: "–",
    labial: "–",
    round: "–",
    labiodental: "–",
    coronal: "+",
    anterior: "+",
    distributed: "+",
    strident: "+",
    lateral: "–",
    dorsal: "+",
    high: "+",
    low: "–",
    front: "+",
    back: "–",
    tense: "0",
  ),
  // VOWELS (Table 4.9)
  // High tense
  "i": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "+",
    low: "–",
    tense: "+",
    front: "+",
    back: "–",
    round: "–",
  ),
  "y": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "+",
    low: "–",
    tense: "+",
    front: "+",
    back: "–",
    round: "+",
  ),
  "ɨ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "+",
    low: "–",
    tense: "+",
    front: "–",
    back: "–",
    round: "–",
  ),
  "ʉ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "+",
    low: "–",
    tense: "+",
    front: "–",
    back: "–",
    round: "+",
  ),
  "ɯ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "+",
    low: "–",
    tense: "+",
    front: "–",
    back: "+",
    round: "–",
  ),
  "u": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "+",
    low: "–",
    tense: "+",
    front: "–",
    back: "+",
    round: "+",
  ),
  // High lax
  "ɪ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "+",
    low: "–",
    tense: "–",
    front: "+",
    back: "–",
    round: "–",
  ),
  "ʏ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "+",
    low: "–",
    tense: "–",
    front: "+",
    back: "–",
    round: "+",
  ),
  "ʊ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "+",
    low: "–",
    tense: "–",
    front: "–",
    back: "+",
    round: "+",
  ),
  // Mid tense
  "e": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "–",
    tense: "+",
    front: "+",
    back: "–",
    round: "–",
  ),
  "ø": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "–",
    tense: "+",
    front: "+",
    back: "–",
    round: "+",
  ),
  "ɘ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "–",
    tense: "+",
    front: "–",
    back: "–",
    round: "–",
  ),
  "ɵ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "–",
    tense: "+",
    front: "–",
    back: "–",
    round: "+",
  ),
  "ɤ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "–",
    tense: "+",
    front: "–",
    back: "+",
    round: "–",
  ),
  "o": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "–",
    tense: "+",
    front: "–",
    back: "+",
    round: "+",
  ),
  // Mid lax
  "ɛ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "–",
    tense: "–",
    front: "+",
    back: "–",
    round: "–",
  ),
  "œ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "–",
    tense: "–",
    front: "+",
    back: "–",
    round: "+",
  ),
  "ə": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "–",
    tense: "–",
    front: "–",
    back: "–",
    round: "–",
  ),
  "ɞ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "–",
    tense: "–",
    front: "–",
    back: "–",
    round: "+",
  ),
  "ʌ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "–",
    tense: "–",
    front: "–",
    back: "+",
    round: "–",
  ),
  "ɔ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "–",
    tense: "–",
    front: "–",
    back: "+",
    round: "+",
  ),
  // Low
  "æ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "+",
    tense: "0",
    front: "+",
    back: "–",
    round: "–",
  ),
  "ɶ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "+",
    tense: "0",
    front: "+",
    back: "–",
    round: "+",
  ),
  "a": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "+",
    tense: "0",
    front: "–",
    back: "–",
    round: "–",
  ),
  "ɑ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "+",
    tense: "0",
    front: "–",
    back: "+",
    round: "–",
  ),
  "ɒ": (
    syllabic: "+",
    consonantal: "–",
    sonorant: "+",
    continuant: "+",
    voice: "+",
    high: "–",
    low: "+",
    tense: "0",
    front: "–",
    back: "+",
    round: "+",
  ),
)

// Feature matrix display function
/// Display complete feature matrix for an IPA segment
///
/// Takes an IPA symbol (Unicode or tipa-style) and displays its complete
/// distinctive feature specification from Hayes (2009).
///
/// Arguments:
/// - segment (string): IPA symbol (e.g., "p", "i", "\\t s" for t͡s)
/// - all (bool): Show all features including 0 values (default: false)
///
/// Returns: Formatted feature matrix in SPE-style notation
///
/// Example:
/// ```
/// #feat-matrix("p")
/// #feat-matrix("t \\t s")  // affricate using tipa notation
/// #feat-matrix("i", all: true)  // show all features including 0
/// ```
#let feat-matrix(segment, all: false) = context {
  // Convert tipa notation to Unicode if needed
  let symbol = ipa-to-unicode(segment).trim()

  // Look up features
  if symbol not in feature-data {
    return text(fill: red)[*Error:* No feature data for "#symbol"]
  }

  let features = feature-data.at(symbol)
  let feature-list = ()

  // Build feature list with readable names
  for (feature-name, value) in features {
    if all or value != "0" {
      // Show all features or only specified ones
      // Format feature names for display
      let display-name = feature-name
        .replace("spread_gl", "spread gl")
        .replace("constr_gl", "constr gl")
        .replace("delayed_release", "del rel")
      feature-list.push(value + display-name)
    }
  }

  // Display as inline block with top alignment to allow side-by-side placement
  let phoneme = text(size: 1em, font: phonokit-font.get())[/#symbol/]

  // Build matrix manually for precise control over alignment
  let features = feature-list.map(f => text(font: phonokit-font.get(), size: 0.8em)[#f])
  let content-stack = stack(
    dir: ttb,
    spacing: 0.55em,
    ..features,
  )

  // Wrap in brackets with precise positioning
  // Add horizontal padding inside brackets for better spacing
  let matrix = box[
    $lr(
      [#h(0.15em)#content-stack#h(0.15em)],
      size: #100%
    )$
  ]

  // Use box with baseline at bottom (100%) for top alignment
  // Counter-intuitively, this makes the tops align
  box(baseline: 100%)[
    #grid(
      columns: 1,
      row-gutter: 1.5em,
      // Phoneme in large fixed box, anchored at bottom for consistent matrix starting point
      // This ensures all matrices start at exactly the same vertical position
      align(center, box(height: 2em, align(bottom, phoneme))),
      // Feature matrix starts at fixed position below
      align(center, matrix),
    )
  ]
}
